name: Test Commit

on:
  workflow_dispatch:
    inputs:
      commit:
        description: 'Commit SHA to test'
        required: true
        type: string

env:
  FORCE_COLOR: 1
  RUFF_OUTPUT_FORMAT: github
  COLUMNS: 120

jobs:
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      result: ${{ steps.lint.outcome }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Check for code issues (ruff check)
        id: lint
        uses: astral-sh/ruff-action@v3

  format:
    name: Format (ruff)
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      result: ${{ steps.format.outcome }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit }}

      - name: Check code format (ruff format)
        id: format
        uses: astral-sh/ruff-action@v3
        with:
          args: "format --check"

  typecheck:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      result: ${{ steps.typecheck.outcome }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --no-group docs

      - name: Static type checking (mypy)
        id: typecheck
        run: uv run --no-group docs mypy src/

  test:
    name: Test (pytest)
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      result: ${{ steps.test.outcome }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.commit }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: uv sync --all-extras --no-group lint

      - name: Run tests
        id: test
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: uv run --no-group docs pytest --tb=short

  report:
    name: Report Results
    runs-on: ubuntu-latest
    needs: [lint, format, typecheck, test]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Test Results for commit ${{ inputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint (ruff check) | ${{ needs.lint.outputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Format (ruff format) | ${{ needs.format.outputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check (mypy) | ${{ needs.typecheck.outputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests (pytest) | ${{ needs.test.outputs.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Set output
        id: results
        run: |
          echo "lint=${{ needs.lint.outputs.result }}" >> $GITHUB_OUTPUT
          echo "format=${{ needs.format.outputs.result }}" >> $GITHUB_OUTPUT
          echo "typecheck=${{ needs.typecheck.outputs.result }}" >> $GITHUB_OUTPUT
          echo "test=${{ needs.test.outputs.result }}" >> $GITHUB_OUTPUT
